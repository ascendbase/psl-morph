<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Face Morphing App</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1834893288794089"
     crossorigin="anonymous"></script>
    <meta name="google-adsense-account" content="ca-pub-1834893288794089">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fafafa;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e1e8ed;
        }
        
        .header {
            background: #6d849a;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #2c3e50;
        }

        .nav-tab:hover {
            background: #f0f0f0;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            border: 1px solid #e1e8ed;
            border-left: 4px solid #3498db;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .table tr:hover {
            background: #f8f9ff;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 2px;
        }

        .btn-primary {
            background: #2c3e50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #34495e;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #2ecc71;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #181818;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2c3e50;
        }
        
        .back-link {
            display: inline-block;
            color: #6d849a;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 300px;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
        }

        .search-box input:focus {
            outline: none;
            border-color: #2c3e50;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Admin Dashboard</h1>
            <p>Manage users, payments, and system settings</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">üìä Overview</button>
            <button class="nav-tab" onclick="showTab('gpu')">üñ•Ô∏è GPU Settings</button>
            <button class="nav-tab" onclick="showTab('ai-prompt')">ü§ñ AI System Prompt</button>
            <button class="nav-tab" onclick="showTab('users')">üë• Users</button>
            <button class="nav-tab" onclick="showTab('payments')">üí≥ Payments</button>
            <button class="nav-tab" onclick="showTab('generations')">üé® Generations</button>
            <button class="nav-tab" onclick="showTab('facial-evaluations')">üë®‚Äç‚öïÔ∏è Facial Evaluations</button>
            <button class="nav-tab" onclick="showTab('ratios-morphs')">üìè Ratios Morphs</button>
        </div>
        
        <div class="content">
            <a href="{{ url_for('dashboard') }}" class="back-link">‚Üê Back to Dashboard</a>
            
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">{{ stats.total_users }}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ stats.total_generations }}</div>
                        <div class="stat-label">Total Generations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${{ "%.2f"|format(stats.total_revenue) }}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ stats.pending_payments }}</div>
                        <div class="stat-label">Pending Payments</div>
                    </div>
                </div>
            </div>
            
            <!-- GPU Settings Tab -->
            <div id="gpu" class="tab-content">
                <h2 style="margin-bottom: 20px;">üñ•Ô∏è GPU & Tunnel Settings</h2>
                
                <!-- Current GPU Status -->
                <div class="table-container" style="margin-bottom: 30px;">
                    <h3 style="padding: 15px; margin: 0; background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">Current GPU Status</h3>
                    <div style="padding: 20px;">
                        <div id="gpuStatus" style="margin-bottom: 20px;">
                            <p>Loading GPU status...</p>
                        </div>
                        <button class="btn btn-primary" onclick="refreshGpuStatus()">üîÑ Refresh Status</button>
                    </div>
                </div>
                
                <!-- Manual Tunnel URL Setting -->
                <div class="table-container">
                    <h3 style="padding: 15px; margin: 0; background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">Manual Tunnel URL Configuration</h3>
                    <div style="padding: 20px;">
                        <form id="tunnelForm">
                            <div class="form-group">
                                <label for="tunnelUrl">Cloudflare Tunnel URL:</label>
                                <input type="url" id="tunnelUrl" placeholder="https://your-tunnel-url.trycloudflare.com" required>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    Paste the exact tunnel URL from your local Cloudflare tunnel here
                                </small>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-success">üíæ Set Tunnel URL</button>
                                <button type="button" class="btn btn-secondary" onclick="testTunnelUrl()">üß™ Test Connection</button>
                                <button type="button" class="btn btn-danger" onclick="clearTunnelUrl()">üóëÔ∏è Clear URL</button>
                            </div>
                        </form>
                        
                        <div id="tunnelStatus" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;">
                            <!-- Status messages will appear here -->
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>üìã Instructions:</h4>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>Start your local ComfyUI on port 8188</li>
                                <li>Run: <code style="background: #e9ecef; padding: 2px 6px; border-radius: 4px;">cloudflared tunnel --url http://127.0.0.1:8188</code></li>
                                <li>Copy the tunnel URL (e.g., https://abc-def.trycloudflare.com)</li>
                                <li>Paste it above and click "Set Tunnel URL"</li>
                                <li>Test the connection to ensure it works</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI System Prompt Tab -->
            <div id="ai-prompt" class="tab-content">
                <h2 style="margin-bottom: 20px;">ü§ñ AI System Prompt for Automated Facial Analysis</h2>
                
                <div class="table-container">
                    <h3 style="padding: 15px; margin: 0; background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">System Prompt Configuration</h3>
                    <div style="padding: 20px;">
                        <form id="systemPromptForm">
                            <div class="form-group">
                                <label for="systemPromptText">System Prompt for AI Model:</label>
                                <textarea id="systemPromptText" rows="15" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 0.9em; resize: vertical;" placeholder="Enter the system prompt that will guide the AI's facial analysis..."></textarea>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    This prompt will be used by the AI model to analyze facial features. Include detailed instructions about the 8 facial features and their importance scores.
                                </small>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-success">üíæ Update System Prompt</button>
                                <button type="button" class="btn btn-secondary" onclick="loadCurrentPrompt()">üîÑ Load Current Prompt</button>
                                <button type="button" class="btn btn-primary" onclick="resetToDefault()">üîß Reset to Default</button>
                            </div>
                        </form>
                        
                        <div id="promptStatus" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;">
                            <!-- Status messages will appear here -->
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>üìã Instructions:</h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>This prompt guides the AI model when analyzing facial features automatically</li>
                                <li>Include detailed descriptions of the 8 facial features and their importance scores</li>
                                <li>The AI will use this prompt to compare original vs morphed images</li>
                                <li>Changes take effect immediately for new analyses</li>
                                <li>Keep the prompt between 100-5000 characters</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="Search users by email..." onkeyup="filterUsers()">
                </div>
                
                <div class="table-container">
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Credits</th>
                                <th>Generations</th>
                                <th>Status</th>
                                <th>Verified</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.email }}</td>
                                <td>{{ user.credits }}</td>
                                <td>{{ user.generations|length }}</td>
                                <td>
                                    {% if user.is_blocked %}
                                    <span class="status-badge status-failed">Blocked</span>
                                    {% elif not user.is_active %}
                                    <span class="status-badge status-pending">Inactive</span>
                                    {% else %}
                                    <span class="status-badge status-completed">Active</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_verified %}
                                    <span class="status-badge status-completed">Verified</span>
                                    {% else %}
                                    <span class="status-badge status-pending">Not Verified</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="editUser('{{ user.id }}', '{{ user.email }}', {{ user.credits }})">
                                        Edit Credits
                                    </button>
                                    {% if not user.is_admin %}
                                    <button class="btn {% if user.is_blocked %}btn-success{% else %}btn-danger{% endif %}"
                                            onclick="toggleBlockUser('{{ user.id }}', '{{ user.email }}', {{ user.is_blocked|lower }})">
                                        {% if user.is_blocked %}Unblock{% else %}Block{% endif %}
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <div class="search-box">
                    <input type="text" id="paymentSearch" placeholder="Search payments..." onkeyup="filterPayments()">
                </div>
                
                <div class="table-container">
                    <table class="table" id="paymentsTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Credits</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>{{ transaction.user.email }}</td>
                                <td>${{ "%.2f"|format(transaction.amount_usd) }}</td>
                                <td>{{ transaction.credits_purchased }}</td>
                                <td>{{ transaction.payment_provider.title() }}</td>
                                <td>
                                    <span class="status-badge status-{{ transaction.payment_status }}">
                                        {{ transaction.payment_status.title() }}
                                    </span>
                                </td>
                                <td>{{ transaction.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if transaction.payment_status == 'pending' %}
                                    <button class="btn btn-success" onclick="approvePayment('{{ transaction.id }}')">
                                        Approve
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectPayment('{{ transaction.id }}')">
                                        Reject
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Generations Tab -->
            <div id="generations" class="tab-content">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Preset</th>
                                <th>Status</th>
                                <th>Credit Type</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for generation in generations %}
                            <tr>
                                <td>{{ generation.user.email }}</td>
                                <td>{{ generation.preset }}</td>
                                <td>
                                    <span class="status-badge status-{{ generation.status }}">
                                        {{ generation.status.title() }}
                                    </span>
                                </td>
                                <td>
                                    {% if generation.used_free_credit %}
                                    Free
                                    {% else %}
                                    Paid
                                    {% endif %}
                                </td>
                                <td>{{ generation.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Facial Evaluations Tab -->
            <div id="facial-evaluations" class="tab-content">
                <div class="search-box">
                    <input type="text" id="facialEvalSearch" placeholder="Search facial evaluations..." onkeyup="filterFacialEvaluations()">
                </div>
                
                <div class="table-container">
                    <table class="table" id="facialEvaluationsTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Request Date</th>
                                <th>Response Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in facial_evaluation_requests %}
                            <tr>
                                <td>{{ request.user.email }}</td>
                                <td>
                                    <span class="status-badge status-{{ request.status }}">
                                        {{ request.status.title() }}
                                    </span>
                                </td>
                                <td>{{ request.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if request.response_date %}
                                    {{ request.response_date.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if request.status == 'pending' %}
                                    <a href="/admin/facial-evaluation/{{ request.id }}" class="btn btn-primary">
                                        üëÅÔ∏è View & Respond
                                    </a>
                                    {% else %}
                                    <a href="/admin/facial-evaluation/{{ request.id }}" class="btn btn-secondary">
                                        üëÅÔ∏è View Response
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if not facial_evaluation_requests %}
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h3>üë®‚Äç‚öïÔ∏è No Facial Evaluation Requests Yet</h3>
                    <p>When users request facial evaluations, they will appear here for you to review and respond.</p>
                    <div style="margin-top: 20px;">
                        <a href="/admin/facial-evaluations" class="btn btn-primary">
                            üìÅ Go to Full Facial Evaluation Management & File System
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Ratios Morphs Tab -->
            <div id="ratios-morphs" class="tab-content">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Request Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in ratios_morph_requests %}
                            <tr>
                                <td>{{ request.user.email }}</td>
                                <td>
                                    <span class="status-badge status-{{ request.status }}">
                                        {{ request.status.title() }}
                                    </span>
                                </td>
                                <td>{{ request.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <a href="/admin/ratios-morph/{{ request.id }}" class="btn btn-primary">
                                        üëÅÔ∏è View & Respond
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h3>Edit User Credits</h3>
                <p id="userEmail"></p>
            </div>
            <form id="editUserForm">
                <div class="form-group">
                    <label for="currentCredits">Current Credits:</label>
                    <input type="number" id="currentCredits" readonly>
                </div>
                <div class="form-group">
                    <label for="creditAction">Action:</label>
                    <select id="creditAction">
                        <option value="add">Add Credits</option>
                        <option value="set">Set Credits</option>
                        <option value="subtract">Subtract Credits</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="creditAmount">Amount:</label>
                    <input type="number" id="creditAmount" min="0" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Update Credits</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUserId = null;

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function editUser(userId, email, credits) {
            currentUserId = userId;
            document.getElementById('userEmail').textContent = email;
            document.getElementById('currentCredits').value = credits;
            document.getElementById('creditAmount').value = '';
            document.getElementById('editUserModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        document.getElementById('editUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const action = document.getElementById('creditAction').value;
            const amount = parseInt(document.getElementById('creditAmount').value);
            
            if (!amount || amount < 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            fetch('/admin/update-credits', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: currentUserId,
                    action: action,
                    amount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Credits updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error updating credits: ' + error);
            });
        });

        function approvePayment(transactionId) {
            if (confirm('Are you sure you want to approve this payment?')) {
                fetch(`/payments/admin/approve-payment/${transactionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Payment approved and credits added!');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error approving payment: ' + error);
                });
            }
        }

        function rejectPayment(transactionId) {
            if (confirm('Are you sure you want to reject this payment?')) {
                fetch(`/admin/reject-payment/${transactionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Payment rejected!');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error rejecting payment: ' + error);
                });
            }
        }

        function filterUsers() {
            const input = document.getElementById('userSearch');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('usersTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const email = rows[i].getElementsByTagName('td')[0];
                if (email) {
                    const txtValue = email.textContent || email.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        function filterPayments() {
            const input = document.getElementById('paymentSearch');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('paymentsTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < cells.length; j++) {
                    const txtValue = cells[j].textContent || cells[j].innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                
                rows[i].style.display = found ? '' : 'none';
            }
        }

        function toggleBlockUser(userId, email, isBlocked) {
            const action = isBlocked ? 'unblock' : 'block';
            const confirmMessage = `Are you sure you want to ${action} user ${email}?`;
            
            if (confirm(confirmMessage)) {
                fetch(`/admin/block-user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error updating user status: ' + error);
                });
            }
        }

        // GPU Settings Functions
        function refreshGpuStatus() {
            const statusDiv = document.getElementById('gpuStatus');
            statusDiv.innerHTML = '<p>üîÑ Checking GPU status...</p>';
            
            fetch('/gpu-status')
                .then(response => response.json())
                .then(data => {
                    let statusHtml = '';
                    if (data.available) {
                        statusHtml = `
                            <div style="color: #27ae60; font-weight: bold;">
                                ‚úÖ GPU Available - ${data.status}
                            </div>
                            <p><strong>Type:</strong> ${data.gpu_type}</p>
                            <p><strong>Message:</strong> ${data.message}</p>
                            ${data.url ? `<p><strong>URL:</strong> ${data.url}</p>` : ''}
                        `;
                    } else {
                        statusHtml = `
                            <div style="color: #e74c3c; font-weight: bold;">
                                ‚ùå GPU Unavailable - ${data.status}
                            </div>
                            <p><strong>Message:</strong> ${data.message}</p>
                            ${data.error ? `<p><strong>Error:</strong> ${data.error}</p>` : ''}
                        `;
                    }
                    statusDiv.innerHTML = statusHtml;
                })
                .catch(error => {
                    statusDiv.innerHTML = `
                        <div style="color: #e74c3c; font-weight: bold;">
                            ‚ùå Error checking GPU status
                        </div>
                        <p><strong>Error:</strong> ${error.message}</p>
                    `;
                });
        }

        function testTunnelUrl() {
            const url = document.getElementById('tunnelUrl').value.trim();
            if (!url) {
                alert('Please enter a tunnel URL first');
                return;
            }
            
            const statusDiv = document.getElementById('tunnelStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = 'üß™ Testing connection...';
            
            // Test the URL by trying to reach /system_stats
            const testUrl = url.endsWith('/') ? url + 'system_stats' : url + '/system_stats';
            
            fetch(testUrl, { mode: 'cors' })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error(`HTTP ${response.status}`);
                })
                .then(data => {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `
                        ‚úÖ Connection successful!
                        <br><strong>ComfyUI Version:</strong> ${data.system?.comfyui_version || 'Unknown'}
                        <br><strong>Devices:</strong> ${data.devices?.length || 0} GPU(s) detected
                    `;
                })
                .catch(error => {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = `‚ùå Connection failed: ${error.message}`;
                });
        }

        function clearTunnelUrl() {
            if (confirm('Are you sure you want to clear the tunnel URL?')) {
                fetch('/register-tunnel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-TUNNEL-SECRET': 'morphpas'
                    },
                    body: JSON.stringify({ url: '' })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tunnelUrl').value = '';
                    const statusDiv = document.getElementById('tunnelStatus');
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = '‚úÖ Tunnel URL cleared successfully';
                    refreshGpuStatus();
                })
                .catch(error => {
                    alert('Error clearing tunnel URL: ' + error.message);
                });
            }
        }

        // Handle tunnel form submission
        document.getElementById('tunnelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = document.getElementById('tunnelUrl').value.trim();
            if (!url) {
                alert('Please enter a tunnel URL');
                return;
            }
            
            const statusDiv = document.getElementById('tunnelStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = 'üíæ Setting tunnel URL...';
            
            fetch('/register-tunnel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-TUNNEL-SECRET': 'morphpas'
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = '‚úÖ Tunnel URL set successfully! GPU client updated.';
                    refreshGpuStatus();
                } else {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = `‚ùå Error: ${data.error}`;
                }
            })
            .catch(error => {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error setting tunnel URL: ${error.message}`;
            });
        });

        function filterFacialEvaluations() {
            const input = document.getElementById('facialEvalSearch');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('facialEvaluationsTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < cells.length; j++) {
                    const txtValue = cells[j].textContent || cells[j].innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                
                rows[i].style.display = found ? '' : 'none';
            }
        }

        // AI System Prompt Functions
        function loadCurrentPrompt() {
            const statusDiv = document.getElementById('promptStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = 'üîÑ Loading current prompt...';
            
            fetch('/admin/update-system-prompt', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('systemPromptText').value = data.current_prompt;
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = '‚úÖ Current prompt loaded successfully';
                } else {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = `‚ùå Error loading prompt: ${data.error}`;
                }
            })
            .catch(error => {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error loading prompt: ${error.message}`;
            });
        }

        function resetToDefault() {
            if (confirm('Are you sure you want to reset to the default system prompt? This will overwrite any custom changes.')) {
                const defaultPrompt = `You are an expert facial features analyst. Your task is to compare two images of a face, one original and one morphed, and identify the differences in facial features based on the following criteria. For each feature, evaluate the "amount of difference" on a scale of 1-10 (1 being almost no difference, 10 being a very significant difference). Then, multiply this difference score by the "importance" score (provided in parentheses next to each feature). Finally, list all features based on these individual relative importance scores, from highest to lowest.

Facial Features and their Importance:
1. Facial leanness (Importance = 8): Appearance of "tight" facial skin without any visible facial fat sagging. Shows the underlying bone structure, increases perceived facial depth via various shadows under various lighting. The desired appearance depends not only on the obvious total low body fat % levels but on the underlying bone morphology AND certain soft tissues (SMAS) morphology.
2. Facial Width (Importance = 7): Both bizygomatic (cheekbones) and bigonial (jaw)
3. Eyes (Importance = 6): I'm talking about the eyes morphology separately from the eyebrows appearance here. The specific relevant parameters here are: deep set, compact (smaller and more almond shaped) or bigger (rounder) and wide eyes (high PFL, low PFH) or rounder (low PFL).
4. Nose (Importance = 5): nose tip width and bulbosity instead of narrower or more refined, sharper nose tip, symmetry, nose tip rotation (tip and nostrils pointring downward or upwards)
5. Health Indicators (Importance = 4): Clear, homogenous (even) skin texture without wrinkles, acne scars, signs of skin aging or other skin imperfections. Symmetrical facial features like hairline, temporal bones, eyebrows, eyes (+ eye focus (no amblyopia)), nose bridge and tip, lips, chin, cheekbones, and mandible alignment. Straight hairline without balding patterns.
6. Mouth and Lips (Importance = 3): mouth width and lips volume (both upper lip and lower lip, and their volumes ratio)
7. Facial Angularity (Importance = 2): I'm talking specifically about the contour of the face here. Not the general facial leanness, but certain facial bones spots angularity. Angularity spots: temporal cave in, cheekbones outwards, ramus cave in, gonions outwards, mandible cave in, chin outwards (square).
8. Eyebrows (Importance = 1): Wide (visible inner and outer corners eyebrows region), thick, closet set (vertically) eyebrows.`;
                
                document.getElementById('systemPromptText').value = defaultPrompt;
                
                const statusDiv = document.getElementById('promptStatus');
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = '‚úÖ Default prompt loaded. Click "Update System Prompt" to save.';
            }
        }

        // Handle system prompt form submission
        document.getElementById('systemPromptForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const promptText = document.getElementById('systemPromptText').value.trim();
            if (!promptText) {
                alert('Please enter a system prompt');
                return;
            }
            
            if (promptText.length < 100) {
                alert('System prompt must be at least 100 characters long');
                return;
            }
            
            if (promptText.length > 5000) {
                alert('System prompt must be less than 5000 characters');
                return;
            }
            
            const statusDiv = document.getElementById('promptStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = 'üíæ Updating system prompt...';
            
            fetch('/admin/update-system-prompt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt_text: promptText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = '‚úÖ System prompt updated successfully! Changes will take effect for new analyses.';
                } else {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = `‚ùå Error: ${data.error}`;
                }
            })
            .catch(error => {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error updating prompt: ${error.message}`;
            });
        });

        // Load GPU status when GPU tab is opened
        document.addEventListener('DOMContentLoaded', function() {
            refreshGpuStatus();
            // Load current prompt when page loads
            loadCurrentPrompt();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editUserModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html><environment_details>
