# GitHub Actions Docker Build Setup Guide
## Complete Step-by-Step Instructions

## Overview

This guide will help you set up automatic Docker image building via GitHub Actions, which will:
- ‚úÖ Build ComfyUI with Impact-Pack automatically
- ‚úÖ Push to DockerHub
- ‚úÖ Provide image for RunPod deployment
- ‚úÖ Save you from local Docker issues

---

## Step 1: Set Up DockerHub Credentials (5 minutes)

### 1.1 Create DockerHub Account (if needed)
1. Go to https://hub.docker.com/signup
2. Create account with username: `ascendbase`
3. Note your password

### 1.2 Add GitHub Repository Secrets

1. **Go to your GitHub repository:**
   - Navigate to: `https://github.com/ascendbase/psl-morph`

2. **Add DockerHub credentials:**
   - Click **Settings** tab
   - Click **Secrets and variables** ‚Üí **Actions**
   - Click **New repository secret**

3. **Add first secret:**
   - Name: `DOCKER_USERNAME`
   - Value: `ascendbase` (your DockerHub username)
   - Click **Add secret**

4. **Add second secret:**
   - Name: `DOCKER_PASSWORD`
   - Value: `your_dockerhub_password`
   - Click **Add secret**

**‚ö†Ô∏è Important:** Use your DockerHub password, not login token!

---

## Step 2: Push Code to GitHub (3 minutes)

### 2.1 Navigate to Your Project Directory

```cmd
cd d:\Morph-app
```

### 2.2 Add All New Files

```cmd
git add .
```

### 2.3 Commit Changes

```cmd
git commit -m "Add RunPod ComfyUI Docker setup with Impact-Pack"
```

### 2.4 Push to GitHub

```cmd
git push origin main
```

**üéâ This triggers the GitHub Actions build automatically!**

---

## Step 3: Monitor the Build (30-45 minutes)

### 3.1 Check Build Status

1. **Go to GitHub Actions:**
   - Navigate to: `https://github.com/ascendbase/psl-morph/actions`

2. **Monitor progress:**
   - Click on the running workflow
   - Watch the build progress
   - Build includes:
     - ‚úÖ Checkout code
     - ‚úÖ Set up Docker Buildx
     - ‚úÖ Login to Docker Hub
     - ‚úÖ Build ComfyUI image
     - ‚úÖ Push to DockerHub

### 3.2 Build Timeline

**Expected duration: 30-45 minutes**
- Base image download: 5-10 minutes
- ComfyUI installation: 10-15 minutes
- Impact-Pack installation: 15-20 minutes
- Model downloads: 5-10 minutes
- Final push: 2-5 minutes

### 3.3 What to Expect

**‚úÖ Success indicators:**
- All steps show green checkmarks
- Summary shows: "Docker Build Success"
- Image available at: `https://hub.docker.com/r/ascendbase/comfyui-morph`

**‚ùå Failure indicators:**
- Red X on any step
- Summary shows: "Docker Build Failed"
- Check logs for specific errors

---

## Step 4: Verify the Image (2 minutes)

### 4.1 Check DockerHub

1. **Go to your image:**
   - Navigate to: `https://hub.docker.com/r/ascendbase/comfyui-morph`

2. **Verify image exists:**
   - You should see `latest` tag
   - Image size should be ~8-12 GB
   - Last updated should be recent

### 4.2 Pull and Test (Optional)

If you want to test locally:

```cmd
docker pull ascendbase/comfyui-morph:latest
docker run -p 8188:8188 ascendbase/comfyui-morph:latest
```

---

## Step 5: Use with RunPod (5 minutes)

### 5.1 Create RunPod Endpoint

1. **Go to RunPod console:**
   - Navigate to: https://www.runpod.io/console/serverless

2. **Create new endpoint:**
   - Click **"+ New Endpoint"**
   - **Name:** `morph-comfyui-endpoint`
   - **Docker Image:** `ascendbase/comfyui-morph:latest`
   - **GPU Type:** RTX 4090 (recommended) or RTX 4060 Ti
   - **Container Disk:** 20 GB
   - **Idle Timeout:** 5 seconds
   - **Max Workers:** 1

3. **Deploy:**
   - Click **"Deploy"**
   - Wait 2-3 minutes for deployment

### 5.2 Get Endpoint ID

1. **From endpoint details page:**
   - Copy the Endpoint ID (looks like: `abc123def456`)
   - This is your `RUNPOD_ENDPOINT_ID`

### 5.3 Update .env File

Add to your `.env` file:

```bash
# RunPod Configuration
RUNPOD_API_KEY=your_runpod_api_key
RUNPOD_ENDPOINT_ID=your_endpoint_id_here
```

---

## Step 6: Test the Integration (2 minutes)

### 6.1 Run the Test Script

```cmd
python test_runpod_comfyui.py
```

### 6.2 Expected Output

```
RunPod ComfyUI Setup Test
============================================================

‚úì API Key loaded: runpod_xxx...
‚úì Endpoint ID: abc123def456
‚úì Client created

Test 1: Health Check
------------------------------------------------------------
‚úì Endpoint is healthy
‚úì Found Dockerfile.runpod.comfyui

Test 3: Simple Workflow Test
------------------------------------------------------------
‚úì Test image found: betaface_test_images/test1.jpg

Running FaceDetailer workflow...
This may take 30-60 seconds on first run (cold start)...

‚úì Workflow executed successfully!
Execution time: 45.2 seconds
Output: {'image': 'output_001.png'}

============================================================
ALL TESTS PASSED! ‚úì
============================================================
```

---

## Troubleshooting

### Build Failed with Memory Error

**If you see "Bus error" or memory issues in GitHub Actions:**

1. **The GitHub Actions runner has 7GB RAM** - should be enough
2. **If it still fails, try the optimized Dockerfile:**
   - Replace `Dockerfile.runpod.comfyui` with content from `FIX_DOCKER_BUILD_MEMORY.md`
   - Commit and push again

### DockerHub Login Failed

**Error: "unauthorized: incorrect username or password"**

1. **Check your GitHub secrets:**
   - `DOCKER_USERNAME`: Should be `ascendbase`
   - `DOCKER_PASSWORD`: Should be your DockerHub password (not token)

2. **Verify DockerHub account is active:**
   - Login to https://hub.docker.com manually
   - Check if account is verified

### Build Times Out

**If build takes longer than 60 minutes:**

1. **GitHub Actions has a 6-hour timeout** - should be enough
2. **If it times out, the image might be too large**
3. **Consider using a smaller base image or fewer models**

### RunPod Deployment Fails

**If RunPod can't pull the image:**

1. **Check image exists on DockerHub:**
   - Go to `https://hub.docker.com/r/ascendbase/comfyui-morph`
   - Verify `latest` tag exists

2. **Check RunPod endpoint settings:**
   - Docker Image: `ascendbase/comfyui-morph:latest`
   - Make sure there are no extra spaces or characters

---

## Benefits of GitHub Actions Build

### ‚úÖ Advantages

1. **Free:** No local Docker Desktop needed
2. **Reliable:** GitHub's infrastructure is robust
3. **Fast:** 30-45 minutes vs hours of local troubleshooting
4. **Automatic:** Builds on every push to main branch
5. **Cached:** Subsequent builds are faster
6. **Monitored:** Easy to track build status and logs

### ‚úÖ No More Local Issues

- ‚ùå No Docker Desktop memory errors
- ‚ùå No "Bus error" failures  
- ‚ùå No build cache issues
- ‚ùå No local disk space problems
- ‚ùå No Windows compatibility issues

---

## Summary

**With this setup:**

1. ‚úÖ **Push code** ‚Üí GitHub builds automatically
2. ‚úÖ **Image appears** on DockerHub in 30-45 minutes
3. ‚úÖ **Use with RunPod** ‚Üí Deploy serverless endpoint
4. ‚úÖ **Test integration** ‚Üí Verify everything works

**Your workflow requirements are met:**
- ComfyUI with Impact-Pack ‚úì
- Impact-Subpack dependency ‚úì  
- SAM and YOLO models ‚úì
- Ready for RunPod deployment ‚úì

**Next time you update the code:** Just push to GitHub and a new image builds automatically! üöÄ
